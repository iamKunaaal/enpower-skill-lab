{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}Edit Lesson - Thinking Coach{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add-lessons.css' %}">
{% endblock %}

{% block content %}
<div class="al-dashboard-page">
    <main class="container-xl py-4 px-4" style="max-width: 1600px;">
        <!-- Page Header -->
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
            <div>
                <h1 class="al-page-title">Edit Lesson</h1>
                <p class="al-page-subtitle mb-0">Update lesson details and content.</p>
            </div>
            <a href="{% url 'teacher:lesson_library' %}" class="al-btn-outline" style="gap: 0.5rem; text-decoration: none;">
                <span class="material-symbols-outlined" style="font-size: 18px;">arrow_back</span>
                Back to Lessons
            </a>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form id="alLessonForm" method="POST" action="{% url 'teacher:edit_lesson' lesson.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Main Content Grid -->
            <div class="row g-4">
                <!-- Left Column (Main Content) -->
                <div class="col-lg-8">
                    <!-- Basic Details Card -->
                    <div class="al-card-box">
                        <h5 class="fw-bold mb-4">Basic Details</h5>

                        <div class="mb-4">
                            <label for="alLessonTitle" class="al-form-label">Lesson Title <span class="al-required">*</span></label>
                            <input type="text" class="al-form-control" id="alLessonTitle" name="title" value="{{ lesson.title }}" placeholder="e.g. Introduction to Financial Literacy" required>
                        </div>

                        <div class="mb-4">
                            <label for="alShortDescription" class="al-form-label">Short Description</label>
                            <textarea class="al-form-control al-textarea" id="alShortDescription" name="description" rows="3" placeholder="Briefly describe what the student will learn...">{{ lesson.description }}</textarea>
                        </div>

                        <div>
                            <label class="al-form-label mb-2">Thumbnail</label>
                            {% if lesson.thumbnail %}
                            <div class="mb-3">
                                <img src="{{ lesson.thumbnail.url }}" alt="Current thumbnail" style="max-width: 200px; border-radius: 8px;">
                                <p class="text-muted small mt-2">Current thumbnail</p>
                            </div>
                            {% endif %}
                            <div class="al-upload-box" id="alThumbnailUpload">
                                <div class="al-file-upload-icon">
                                    <span class="material-symbols-outlined">add_photo_alternate</span>
                                </div>
                                <p class="mb-0 fw-medium">Click to upload or drag & drop</p>
                                <small class="text-muted">SVG, PNG, JPG (800Ã—400)</small>
                            </div>
                            <input type="file" id="alThumbnailInput" name="thumbnail" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <!-- Learning Content Card -->
                    <div class="al-card-box">
                        <h5 class="fw-bold mb-4">Learning Content</h5>

                        <!-- Content Type Tabs -->
                        <input type="hidden" id="alPrimaryContentType" name="primary_content_type" value="{{ lesson.primary_content_type|default:'video' }}">
                        <textarea id="alArticleContentInput" name="article_content" style="display:none;">{{ lesson.article_content|default:'' }}</textarea>
                        <textarea id="alVideoUrlsInput" name="video_urls" style="display:none;">{{ lesson.video_urls|default:'' }}</textarea>
                        <textarea id="alQuizDataInput" name="quiz_data" style="display:none;">{{ lesson.quiz_data|default:'' }}</textarea>
                        <textarea id="alExistingArticleContent" style="display:none;">{{ lesson.article_content|default:'' }}</textarea>
                        <textarea id="alExistingVideoUrls" style="display:none;">{{ lesson.video_urls|default:'' }}</textarea>
                        <textarea id="alExistingQuizData" style="display:none;">{{ lesson.quiz_data|default:'' }}</textarea>
                        <div class="al-lesson-tabs">
                            {% if lesson.primary_content_type == 'video' or not lesson.primary_content_type %}
                            <button type="button" class="active" data-content-type="video">
                                <span class="material-symbols-outlined">play_circle</span>
                                Video
                            </button>
                            {% if resources %}
                            <button type="button" data-content-type="mixed">
                                <span class="material-symbols-outlined">upload_file</span>
                                Resources
                            </button>
                            {% endif %}
                            {% elif lesson.primary_content_type == 'article' %}
                            <button type="button" class="active" data-content-type="article">
                                <span class="material-symbols-outlined">article</span>
                                Article
                            </button>
                            {% if resources %}
                            <button type="button" data-content-type="mixed">
                                <span class="material-symbols-outlined">upload_file</span>
                                Resources
                            </button>
                            {% endif %}
                            {% elif lesson.primary_content_type == 'quiz' %}
                            <button type="button" class="active" data-content-type="quiz">
                                <span class="material-symbols-outlined">quiz</span>
                                Quiz
                            </button>
                            {% elif lesson.primary_content_type == 'mixed' %}
                            <button type="button" class="active" data-content-type="mixed">
                                <span class="material-symbols-outlined">upload_file</span>
                                Resources
                            </button>
                            {% endif %}
                        </div>

                        <!-- Content Area -->
                        <div id="alContentArea"></div>

                        <!-- Existing Resources (shown when Resources tab is active) -->
                        {% if resources %}
                        <div id="alExistingResources" class="mt-3" style="display: none;">
                            <label class="al-form-label mb-2">Uploaded Resources</label>
                            <ul class="list-group mb-3">
                                {% for resource in resources %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="material-symbols-outlined">{% if resource.resource_type == 'pdf' %}picture_as_pdf{% elif resource.resource_type == 'doc' %}description{% elif resource.resource_type == 'ppt' %}slideshow{% elif resource.resource_type == 'xls' %}table_chart{% else %}insert_drive_file{% endif %}</span>
                                        <span>{{ resource.title }}</span>
                                        <span class="badge bg-secondary">{{ resource.resource_type|upper }}</span>
                                    </div>
                                    <a href="{{ resource.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Download</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column (Sidebar) -->
                <div class="col-lg-4">
                    <!-- Action Buttons Card -->
                    <div class="al-card-box">
                        <button type="submit" class="al-btn-primary w-100 mb-3" name="status" value="published">
                            <span class="material-symbols-outlined" style="font-size: 1.125rem;">publish</span>
                            Update & Publish
                        </button>
                        <div class="row g-3">
                            <div class="col-6">
                                <button type="submit" class="al-btn-outline w-100" name="status" value="draft">
                                    Save Draft
                                </button>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'teacher:lesson_library' %}" class="al-btn-ghost w-100 d-flex align-items-center justify-content-center" style="text-decoration: none;">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Card -->
                    <div class="al-card-box">
                        <h5 class="fw-bold mb-4 d-flex align-items-center gap-2">
                            <span class="material-symbols-outlined">school</span>
                            Assignment
                        </h5>

                        <div class="mb-3">
                            <label for="alCompetency" class="al-form-label">Competency</label>
                            <input type="text" class="al-form-control" id="alCompetency" name="competency" value="{{ lesson.competency|default:'' }}" placeholder="Enter competency (e.g., Financial Literacy)">
                        </div>

                        <div class="mb-3">
                            <label for="alLevel" class="al-form-label">Level</label>
                            <select class="al-form-select" id="alLevel" name="level">
                                <option value="">Select Difficulty</option>
                                <option value="beginner" {% if lesson.level == 'beginner' %}selected{% endif %}>Beginner</option>
                                <option value="intermediate" {% if lesson.level == 'intermediate' %}selected{% endif %}>Intermediate</option>
                                <option value="advanced" {% if lesson.level == 'advanced' %}selected{% endif %}>Advanced</option>
                            </select>
                        </div>

                        <div>
                            <label for="alModule" class="al-form-label">Module / Category</label>
                            <input type="text" class="al-form-control" id="alModule" name="module" value="{{ lesson.module|default:'' }}" placeholder="Enter module (e.g., Module 1: Basics)">
                        </div>
                    </div>

                    <!-- Lesson Context Card -->
                    <div class="al-card-box">
                        <h5 class="fw-bold mb-1 d-flex align-items-center gap-2">
                            <span class="material-symbols-outlined">groups</span>
                            Lesson Context
                        </h5>
                        <p class="al-text-xs text-muted mb-4">
                            Define where this lesson will be used.
                        </p>

                        <!-- Applicable Grades -->
                        <div class="mb-4">
                            <label class="al-form-label">
                                Applicable Grade(s) <span class="al-required">*</span>
                            </label>
                            <select class="al-form-select" id="alApplicableGrades" name="applicable_grades">
                                <option value="">Select Grade</option>
                                <option value="8" {% if lesson.applicable_grades == '8' %}selected{% endif %}>Standard 8</option>
                                <option value="9" {% if lesson.applicable_grades == '9' %}selected{% endif %}>Standard 9</option>
                                <option value="10" {% if lesson.applicable_grades == '10' %}selected{% endif %}>Standard 10</option>
                                <option value="11" {% if lesson.applicable_grades == '11' %}selected{% endif %}>Standard 11</option>
                                <option value="12" {% if lesson.applicable_grades == '12' %}selected{% endif %}>Standard 12</option>
                            </select>
                            <small class="text-muted">
                                Select which grade this lesson applies to.
                            </small>
                        </div>
                    </div>

                    <!-- Meta Information Card -->
                    <div class="al-card-box">
                        <h5 class="fw-bold mb-3 d-flex align-items-center gap-2">
                            <span class="material-symbols-outlined">info</span>
                            Information
                        </h5>

                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Lesson ID</span>
                            <span class="fw-medium">LES-{{ lesson.id|stringformat:"05d" }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Created</span>
                            <span class="fw-medium">{{ lesson.created_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Last Updated</span>
                            <span class="fw-medium">{{ lesson.updated_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/add-lessons.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set active menu item
        const navLessons = document.getElementById('nav-lessons');
        if (navLessons) {
            navLessons.classList.add('active');
            const parentDropdown = navLessons.closest('.sidebar-dropdown');
            if (parentDropdown) {
                parentDropdown.classList.add('active');
            }
        }
    });
</script>
{% endblock %}
