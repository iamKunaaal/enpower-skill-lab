/**
 * ========================================
 * ADD CLASS FORM FUNCTIONALITY
 * ========================================
 */
document.addEventListener('DOMContentLoaded', function() {
    // Form Elements
    const schoolSelect = document.getElementById('school');
    const cityInput = document.getElementById('city');
    const academicYearSelect = document.getElementById('academic-year');
    const gradeSelect = document.getElementById('grade');
    const divisionInput = document.getElementById('division');
    const coachSelect = document.getElementById('coach');
    const addClassForm = document.getElementById('addClassForm');

    // Auto-generated display elements
    const classNameDisplay = document.getElementById('classNameDisplay');
    const classCodeDisplay = document.getElementById('classCodeDisplay');

    // Program configuration
    const sessionsInput = document.getElementById('sessions');

    // School and City Mapping (will be populated from server data)
    let schoolCityMap = {};

    // Initialize school city map from data attribute
    if (schoolSelect && schoolSelect.dataset.cities) {
        try {
            schoolCityMap = JSON.parse(schoolSelect.dataset.cities);
        } catch (e) {
            console.error('Error parsing school city data:', e);
        }
    }

    /**
     * ========================================
     * UTILITY FUNCTIONS
     * ========================================
     */

    // Extract grade number from grade text (e.g., "Standard 9" -> "9")
    function extractGradeNumber(gradeText) {
        const match = gradeText.match(/\d+/);
        return match ? match[0] : '';
    }

    // Generate class name from grade and division
    function generateClassName(grade, division) {
        if (!grade || grade === '' || !division) {
            return 'Std --';
        }
        const gradeNum = extractGradeNumber(grade);
        return `Std ${gradeNum}${division.toUpperCase()}`;
    }

    // Generate unique class code
    function generateClassCode(year, grade, division) {
        if (!year || !grade || grade === '' || !division) {
            return 'CLS-YYYY-XX-001';
        }
        const gradeNum = extractGradeNumber(grade);
        const yearStart = year.split('-')[0];
        const randomId = Math.floor(Math.random() * 900) + 100;
        return `CLS-${yearStart}-${gradeNum}${division.toUpperCase()}-${randomId.toString().padStart(3, '0')}`;
    }

    // Update auto-generated fields (class name and code)
    function updateAutoGeneratedFields() {
        if (!gradeSelect || !divisionInput || !academicYearSelect) return;
        
        const grade = gradeSelect.options[gradeSelect.selectedIndex]?.text || '';
        const division = divisionInput.value;
        const year = academicYearSelect.value;

        // Update class name
        const className = generateClassName(grade, division);
        if (classNameDisplay) {
            classNameDisplay.textContent = className;
        }

        // Update class code
        const classCode = generateClassCode(year, grade, division);
        if (classCodeDisplay) {
            classCodeDisplay.textContent = classCode;
        }
    }

    /**
     * ========================================
     * EVENT HANDLERS
     * ========================================
     */

    // School selection change - update city
    if (schoolSelect) {
        schoolSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const schoolId = this.value;
            
            // Get city from data attribute or mapping
            if (selectedOption && selectedOption.dataset.city) {
                cityInput.value = selectedOption.dataset.city;
            } else if (schoolCityMap[schoolId]) {
                cityInput.value = schoolCityMap[schoolId];
            } else {
                cityInput.value = '';
            }

            updateAutoGeneratedFields();
        });
    }

    // Academic year change - update class code
    if (academicYearSelect) {
        academicYearSelect.addEventListener('change', function() {
            updateAutoGeneratedFields();
        });
    }

    // Grade selection change - update class name and code
    if (gradeSelect) {
        gradeSelect.addEventListener('change', function() {
            updateAutoGeneratedFields();
        });
    }

    // Division input change - update class name and code
    if (divisionInput) {
        divisionInput.addEventListener('input', function() {
            // Convert to uppercase automatically
            this.value = this.value.toUpperCase();
            updateAutoGeneratedFields();
        });
    }

    // Form submission
    if (addClassForm) {
        addClassForm.addEventListener('submit', function(e) {
            // Form validation is handled by Django
            // Additional client-side validation can be added here
            
            // Update hidden fields with auto-generated values
            const classNameInput = document.getElementById('class_name');
            const classCodeInput = document.getElementById('class_code');
            
            if (classNameInput && classNameDisplay) {
                classNameInput.value = classNameDisplay.textContent;
            }
            if (classCodeInput && classCodeDisplay) {
                classCodeInput.value = classCodeDisplay.textContent;
            }
        });
    }

    /**
     * ========================================
     * INITIALIZE ON PAGE LOAD
     * ========================================
     */

    // Initialize auto-generated fields with current values
    updateAutoGeneratedFields();

    console.log('Add Class form initialized successfully');
});
