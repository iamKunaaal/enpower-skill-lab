{% extends 'superadmin/base.html' %}
{% load static %}

{% block title %}Class List - Super Admin{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/school_admin/class-list.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <main class="container-xl py-4" style="max-width: 1600px;">
        <!-- Page Header -->
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
            <div>
                <h1 class="h3 mb-1 fw-bold">Class List</h1>
                <p class="text-muted mb-0" style="font-size: 0.875rem;">Manage class structure across all schools.</p>
            </div>
            <a href="{% url 'add_class' %}" class="btn-primary-custom">
                <span class="material-symbols-outlined" style="font-size: 20px;">add</span>
                <span>Add Class</span>
            </a>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Filters Section -->
        <div class="filter-card">
            <div class="row g-3">
                <!-- Location Filter -->
                <div class="col-12 col-sm-6 col-lg-3 col-xl">
                    <label class="form-label-custom">Location</label>
                    <select class="form-select form-select-custom" id="locationFilter">
                        <option value="">All Locations</option>
                        {% for location in locations %}
                        <option value="{{ location }}">{{ location }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- School Filter -->
                <div class="col-12 col-sm-6 col-lg-3 col-xl">
                    <label class="form-label-custom">School</label>
                    <select class="form-select form-select-custom" id="schoolFilter">
                        <option value="">All Schools</option>
                        {% for school in schools %}
                        <option value="{{ school.school_name }}">{{ school.school_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Academic Year Filter -->
                <div class="col-12 col-sm-6 col-lg-2 col-xl">
                    <label class="form-label-custom">Year</label>
                    <select class="form-select form-select-custom" id="yearFilter">
                        <option value="">All Years</option>
                        <option value="2023-2024">2023-2024</option>
                        <option value="2024-2025">2024-2025</option>
                        <option value="2025-2026">2025-2026</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-12 col-sm-6 col-lg-2 col-xl">
                    <label class="form-label-custom">Status</label>
                    <select class="form-select form-select-custom" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>

                <!-- Search Input -->
                <div class="col-12 col-lg-4 col-xl">
                    <label class="form-label-custom">Search</label>
                    <div class="position-relative">
                        <input type="text" id="globalSearch" class="form-control form-control-custom ps-5" placeholder="Search Grade or Section...">
                        <span class="material-symbols-outlined position-absolute" style="left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-subtle); font-size: 20px;">search</span>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-link text-decoration-none fw-medium p-0" id="resetFiltersBtn" style="color: var(--primary); font-size: 0.875rem;">
                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">refresh</span>
                    Reset Filters
                </button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="class-list-card">
            <div class="table-container">
                <table id="classTable" class="table">
                    <thead>
                        <tr>
                            <th>School Name</th>
                            <th>Class</th>
                            <th>Academic Year</th>
                            <th>Thinking Coach</th>
                            <th>Students</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class in classes %}
                        <tr data-school="{{ class.school.school_name }} - {{ class.school.city }}">
                            <td>
                                <div class="school-name">
                                    <svg class="school-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    {{ class.school.school_name }} - {{ class.school.city }}
                                </div>
                            </td>
                            <td>Grade {{ class.grade }} {{ class.division }}</td>
                            <td>{{ class.academic_year }}</td>
                            <td>
                                <div class="teacher-cell">
                                    {% if class.thinking_coach %}
                                    <img src="{% if class.thinking_coach.profile_picture %}{{ class.thinking_coach.profile_picture.url }}{% else %}https://i.pravatar.cc/32?u={{ class.thinking_coach.id }}{% endif %}" class="teacher-avatar" alt="{{ class.thinking_coach.get_full_name }}">
                                    <span>{{ class.thinking_coach.get_full_name|default:class.thinking_coach.username }}</span>
                                    {% else %}
                                    <span class="text-muted">Not Assigned</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ class.student_count }}</td>
                            <td>
                                {% if class.is_active %}
                                <span class="status-badge status-active">Active</span>
                                {% else %}
                                <span class="status-badge status-archived">Archived</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions-cell">
                                    <button class="action-btn" title="View">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                    <button class="action-btn edit-class-btn" data-class-id="{{ class.id }}" title="Edit">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                    </button>
                                    <button class="action-btn" title="Delete">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">No classes found. <a href="{% url 'add_class' %}">Add your first class</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">Showing <strong id="startEntry">1</strong> to <strong id="endEntry">10</strong> of <strong id="totalEntries">{{ classes|length }}</strong> classes</div>
                <div class="pagination-controls">
                    <div class="rows-per-page">
                        <span>Rows per page:</span>
                        <select id="rowsPerPage"><option>10</option><option>25</option><option>50</option></select>
                    </div>
                    <div class="pagination-buttons" id="paginationButtons">
                        <!-- Pagination buttons will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Drawer Overlay -->
<div class="drawer-overlay" id="drawerOverlay"></div>

<!-- Edit Class Drawer -->
<div class="edit-drawer" id="editDrawer">
    <!-- Drawer Header -->
    <div class="drawer-header">
        <div class="drawer-header-content">
            <h2>Edit Class</h2>
            <p>Editing: <span id="editingClassName">Std 9A</span></p>
        </div>
        <button class="drawer-close-btn" id="closeDrawerBtn">
            <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
        </button>
    </div>

    <!-- Drawer Body (Scrollable) -->
    <div class="drawer-body">
        <form id="editClassForm" method="POST">
            {% csrf_token %}
            <input type="hidden" id="editClassId" name="class_id" value="">
            
            <!-- Section 1: Class Details -->
            <div class="drawer-card">
                <div class="drawer-card-header">
                    <span class="material-symbols-outlined">meeting_room</span>
                    <h3>Class Details</h3>
                </div>
                <div class="drawer-form-group">
                    <label class="drawer-form-label">Grade / Standard <span class="required">*</span></label>
                    <select class="drawer-form-select" id="editGrade" name="grade">
                        <option value="">Select Grade</option>
                        {% for value, label in grade_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="drawer-form-group">
                    <label class="drawer-form-label">Division <span class="required">*</span></label>
                    <input type="text" class="drawer-form-control" id="editDivision" name="division" value="">
                </div>

                <div class="drawer-form-group">
                    <label class="drawer-form-label">Class Name</label>
                    <input type="text" class="drawer-form-control" id="editClassName" name="class_name" value="" readonly>
                    <small class="drawer-helper-text">Class name updates automatically based on Grade and Division.</small>
                </div>

                <div class="drawer-form-group">
                    <label class="drawer-form-label">Class Code</label>
                    <input type="text" class="drawer-form-control" id="editClassCode" name="class_code" value="" readonly>
                </div>
            </div>

            <!-- Section 2: School & Academic Context -->
            <div class="drawer-card">
                <div class="drawer-card-header">
                    <span class="material-symbols-outlined">school</span>
                    <h3>School & Academic Context</h3>
                </div>
                <div class="drawer-form-group">
                    <label class="drawer-form-label">School Name <span class="required">*</span></label>
                    <select class="drawer-form-select" id="editSchool" name="school">
                        <option value="">Select School</option>
                        {% for school in schools %}
                        <option value="{{ school.id }}">{{ school.school_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="drawer-form-group">
                    <label class="drawer-form-label">Academic Year <span class="required">*</span></label>
                    <select class="drawer-form-select" id="editAcademicYear" name="academic_year">
                        <option value="2025-2026">2025-2026</option>
                        <option value="2024-2025">2024-2025</option>
                        <option value="2023-2024">2023-2024</option>
                    </select>
                </div>
            </div>

            <!-- Section 3: Thinking Coach Assignment -->
            <div class="drawer-card">
                <div class="drawer-card-header">
                    <span class="material-symbols-outlined">person_check</span>
                    <h3>Thinking Coach Assignment</h3>
                </div>
                <div class="drawer-form-group">
                    <label class="drawer-form-label">Thinking Coach</label>
                    <select class="drawer-form-select" id="editCoach" name="thinking_coach">
                        <option value="">Select Coach</option>
                        {% for coach in coaches %}
                        <option value="{{ coach.id }}">{{ coach.get_full_name|default:coach.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Section 4: Program Configuration -->
            <div class="drawer-card">
                <div class="drawer-card-header">
                    <span class="material-symbols-outlined">event_note</span>
                    <h3>Program Configuration</h3>
                </div>
                <div class="drawer-form-group">
                    <label class="drawer-form-label">Total Sessions <span class="required">*</span></label>
                    <input type="number" class="drawer-form-control" id="editSessions" name="total_sessions" value="48" min="1" max="100">
                </div>
            </div>

            <!-- Section 5: Class Status & Visibility -->
            <div class="drawer-card">
                <div class="drawer-card-header">
                    <span class="material-symbols-outlined">settings</span>
                    <h3>Class Status & Visibility</h3>
                </div>

                <div class="drawer-toggle-group">
                    <div class="drawer-toggle-label">
                        <span class="toggle-title">Class Status</span>
                        <span class="toggle-description">Active / Inactive</span>
                    </div>
                    <div class="drawer-toggle-switch active" id="editClassStatus" data-field="is_active"></div>
                    <input type="hidden" name="is_active" id="editIsActive" value="true">
                </div>

                <div class="drawer-toggle-group">
                    <div class="drawer-toggle-label">
                        <span class="toggle-title">Visible to Students</span>
                        <span class="toggle-description">Show in student dashboards</span>
                    </div>
                    <div class="drawer-toggle-switch active" id="editStudentVisibility" data-field="student_visibility"></div>
                    <input type="hidden" name="student_visibility" id="editStudentVisibilityInput" value="true">
                </div>

                <div class="drawer-toggle-group">
                    <div class="drawer-toggle-label">
                        <span class="toggle-title">Visible to Parents</span>
                        <span class="toggle-description">Show in parent portals</span>
                    </div>
                    <div class="drawer-toggle-switch" id="editParentVisibility" data-field="parent_visibility"></div>
                    <input type="hidden" name="parent_visibility" id="editParentVisibilityInput" value="false">
                </div>

                <div class="drawer-warning">
                    <span class="material-symbols-outlined">warning</span>
                    <span>Inactive classes will not appear in dashboards or reports.</span>
                </div>
            </div>
        </form>
    </div>

    <!-- Drawer Footer (Sticky) -->
    <div class="drawer-footer">
        <button class="btn-drawer-secondary" id="cancelDrawerBtn">Cancel</button>
        <button class="btn-drawer-primary" id="updateClassBtn">Update Class</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="{% static 'js/school_admin/class-list.js' %}"></script>
{% endblock %}
