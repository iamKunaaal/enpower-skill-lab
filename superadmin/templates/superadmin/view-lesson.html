{% extends 'superadmin/base.html' %}
{% load static %}

{% block title %}View Lesson - Super Admin{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/school_admin/add-lessons.css' %}">
<style>
    /* View mode specific styles */
    .al-form-control[readonly],
    .al-form-select[disabled],
    .al-textarea[readonly] {
        background-color: #f8f9fa !important;
        cursor: default;
        opacity: 0.9;
    }
    .al-upload-box.disabled {
        pointer-events: none;
        opacity: 0.7;
    }
    .al-lesson-tabs button {
        pointer-events: auto;
        cursor: pointer;
    }
    /* Content panel visibility */
    .vl-content-panel {
        display: none !important;
    }
    .vl-content-panel.active {
        display: block !important;
    }
    .al-switch.disabled {
        pointer-events: none;
        opacity: 0.7;
    }
    .vl-info-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
        border-radius: 8px;
        font-size: 0.875rem;
        color: #4338CA;
        font-weight: 500;
    }
    .vl-thumbnail-preview {
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .vl-content-display {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        min-height: 150px;
    }
    .vl-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .vl-status-badge .material-symbols-outlined {
        font-size: 14px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .vl-status-published {
        background: #D1FAE5;
        color: #065F46;
    }
    .vl-status-draft {
        background: #F3F4F6;
        color: #6B7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="al-dashboard-page">
    <main class="container-xl py-4 px-4" style="max-width: 1600px;">
        <!-- Page Header -->
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
            <div>
                <h1 class="al-page-title">View Lesson</h1>
                <p class="al-page-subtitle mb-0">Viewing lesson details in read-only mode.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'edit_lesson' lesson.id %}" class="al-btn-primary" style="gap: 0.5rem; text-decoration: none;">
                    <span class="material-symbols-outlined" style="font-size: 18px; line-height: 1;">edit</span>
                    Edit Lesson
                </a>
                <a href="{% url 'lesson_list' %}" class="al-btn-outline" style="gap: 0.5rem; text-decoration: none;">
                    <span class="material-symbols-outlined" style="font-size: 18px; line-height: 1;">arrow_back</span>
                    Back to Lessons
                </a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Read-only Info Banner -->
        <div class="alert alert-info d-flex align-items-center gap-2 mb-4" role="alert">
            <span class="material-symbols-outlined">info</span>
            <span>You are viewing this lesson in read-only mode. Click "Edit Lesson" to make changes.</span>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column (Main Content) -->
            <div class="col-lg-8">
                <!-- Basic Details Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-4">Basic Details</h5>

                    <div class="mb-4">
                        <label class="al-form-label">Lesson Title</label>
                        <input type="text" class="al-form-control" value="{{ lesson.title }}" readonly>
                    </div>

                    <div class="mb-4">
                        <label class="al-form-label">Short Description</label>
                        <textarea class="al-form-control al-textarea" rows="3" readonly>{{ lesson.description|default:"No description provided." }}</textarea>
                    </div>

                    <div>
                        <label class="al-form-label mb-2">Thumbnail</label>
                        {% if lesson.thumbnail %}
                        <div>
                            <img src="{{ lesson.thumbnail.url }}" alt="Lesson thumbnail" class="vl-thumbnail-preview" style="max-width: 400px;">
                        </div>
                        {% else %}
                        <div class="al-upload-box disabled">
                            <div class="al-file-upload-icon">
                                <span class="material-symbols-outlined">hide_image</span>
                            </div>
                            <p class="mb-0 fw-medium text-muted">No thumbnail uploaded</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Learning Content Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-4">Learning Content</h5>

                    <!-- Content Type Tabs - Show only relevant tabs based on primary content type -->
                    <div class="al-lesson-tabs mb-4">
                        {% if lesson.primary_content_type == 'video' or not lesson.primary_content_type %}
                        <button type="button" class="active" data-content-type="video">
                            <span class="material-symbols-outlined">play_circle</span>
                            Video
                        </button>
                        {% if resources %}
                        <button type="button" data-content-type="mixed">
                            <span class="material-symbols-outlined">upload_file</span>
                            Resources
                        </button>
                        {% endif %}
                        {% elif lesson.primary_content_type == 'article' %}
                        <button type="button" class="active" data-content-type="article">
                            <span class="material-symbols-outlined">article</span>
                            Article
                        </button>
                        {% if resources %}
                        <button type="button" data-content-type="mixed">
                            <span class="material-symbols-outlined">upload_file</span>
                            Resources
                        </button>
                        {% endif %}
                        {% elif lesson.primary_content_type == 'quiz' %}
                        <button type="button" class="active" data-content-type="quiz">
                            <span class="material-symbols-outlined">quiz</span>
                            Quiz
                        </button>
                        {% elif lesson.primary_content_type == 'mixed' %}
                        <button type="button" class="active" data-content-type="mixed">
                            <span class="material-symbols-outlined">upload_file</span>
                            Resources
                        </button>
                        {% endif %}
                    </div>

                    <!-- Content Display -->
                    <div id="vlContentDisplay" class="vl-content-display">
                        {% if lesson.primary_content_type == 'video' or not lesson.primary_content_type %}
                        <!-- Video Content -->
                        <div id="vlVideoContent" class="vl-content-panel active">
                            {% if video_urls_list %}
                            <div class="mb-3">
                                <label class="al-form-label">Video URLs</label>
                                <ul class="list-group">
                                    {% for video_url in video_urls_list %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="text-truncate" style="max-width: 70%;">{{ video_url }}</span>
                                        <a href="{{ video_url }}" target="_blank" class="btn btn-sm btn-outline-primary">Watch</a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if videos %}
                            <div class="mb-3">
                                <label class="al-form-label">Uploaded Videos</label>
                                <ul class="list-group">
                                    {% for video in videos %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ video.title }}</span>
                                        <a href="{{ video.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% if not video_urls_list and not videos %}
                            <div class="text-center text-muted py-4">
                                <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.5;">videocam_off</span>
                                <p class="mt-2 mb-0">No video content added yet.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% if resources %}
                        <!-- Resources Content (for video lessons with resources) -->
                        <div id="vlMixedContent" class="vl-content-panel">
                            <div class="mb-3">
                                <label class="al-form-label">Resources</label>
                                <ul class="list-group">
                                    {% for resource in resources %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ resource.title }} ({{ resource.resource_type }})</span>
                                        {% if resource.file %}
                                        <a href="{{ resource.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Download</a>
                                        {% elif resource.url %}
                                        <a href="{{ resource.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        {% elif lesson.primary_content_type == 'article' %}
                        <!-- Article Content -->
                        <div id="vlArticleContent" class="vl-content-panel active">
                            {% if lesson.article_content %}
                            <div class="mb-3">
                                <label class="al-form-label">Article Content</label>
                                <div class="bg-white p-3 rounded border">
                                    {{ lesson.article_content|safe }}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.5;">article</span>
                                <p class="mt-2 mb-0">No article content added yet.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% if resources %}
                        <!-- Resources Content (for article lessons with resources) -->
                        <div id="vlMixedContent" class="vl-content-panel">
                            <div class="mb-3">
                                <label class="al-form-label">Resources</label>
                                <ul class="list-group">
                                    {% for resource in resources %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ resource.title }} ({{ resource.resource_type }})</span>
                                        {% if resource.file %}
                                        <a href="{{ resource.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Download</a>
                                        {% elif resource.url %}
                                        <a href="{{ resource.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        {% elif lesson.primary_content_type == 'quiz' %}
                        <!-- Quiz Content -->
                        <div id="vlQuizContent" class="vl-content-panel active">
                            {% if lesson.quiz_data %}
                            <div class="mb-3">
                                <label class="al-form-label">Quiz Questions</label>
                                <div id="quizDataDisplay" class="bg-white p-3 rounded border">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            <script>
                                (function() {
                                    try {
                                        const quizData = {{ lesson.quiz_data|safe }};
                                        const container = document.getElementById('quizDataDisplay');
                                        if (Array.isArray(quizData) && quizData.length > 0) {
                                            container.innerHTML = quizData.map((q, i) => 
                                                '<div class="p-3 mb-2 bg-light rounded">' +
                                                '<strong>Q' + (i+1) + ':</strong> ' + q.question +
                                                '<br><small class="text-success">Correct Answer: ' + q.correctAnswer + '</small>' +
                                                '</div>'
                                            ).join('');
                                        } else {
                                            container.innerHTML = '<span class="text-muted">No quiz questions.</span>';
                                        }
                                    } catch(e) {
                                        document.getElementById('quizDataDisplay').innerHTML = '<span class="text-muted">Unable to load quiz data.</span>';
                                    }
                                })();
                            </script>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.5;">quiz</span>
                                <p class="mt-2 mb-0">No quiz content added yet.</p>
                            </div>
                            {% endif %}
                        </div>

                        {% elif lesson.primary_content_type == 'mixed' %}
                        <!-- Resources Content -->
                        <div id="vlMixedContent" class="vl-content-panel active">
                            {% if resources %}
                            <div class="mb-3">
                                <label class="al-form-label">Resources</label>
                                <ul class="list-group">
                                    {% for resource in resources %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ resource.title }} ({{ resource.resource_type }})</span>
                                        {% if resource.file %}
                                        <a href="{{ resource.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Download</a>
                                        {% elif resource.url %}
                                        <a href="{{ resource.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.5;">upload_file</span>
                                <p class="mt-2 mb-0">No resources added yet.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column (Sidebar) -->
            <div class="col-lg-4">
                <!-- Status Card -->
                <div class="al-card-box">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">Status</span>
                        {% if lesson.is_published %}
                        <span class="vl-status-badge vl-status-published">
                            <span class="material-symbols-outlined" style="font-size: 14px; line-height: 1;">check_circle</span>
                            Published
                        </span>
                        {% else %}
                        <span class="vl-status-badge vl-status-draft">
                            <span class="material-symbols-outlined" style="font-size: 14px; line-height: 1;">edit_note</span>
                            Draft
                        </span>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{% url 'edit_lesson' lesson.id %}" class="al-btn-primary flex-grow-1" style="text-decoration: none;">
                            <span class="material-symbols-outlined" style="font-size: 1.125rem; line-height: 1;">edit</span>
                            Edit Lesson
                        </a>
                    </div>
                </div>

                <!-- Assignment Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-4 d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">school</span>
                        Assignment
                    </h5>

                    <div class="mb-3">
                        <label class="al-form-label">Competency</label>
                        <input type="text" class="al-form-control" value="{{ lesson.competency|default:'Not assigned' }}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="al-form-label">Level</label>
                        <input type="text" class="al-form-control" value="{{ lesson.level|default:'Not assigned'|title }}" readonly>
                    </div>

                    <div>
                        <label class="al-form-label">Module / Category</label>
                        <input type="text" class="al-form-control" value="{{ lesson.module|default:'Not assigned' }}" readonly>
                    </div>
                </div>

                <!-- Lesson Context Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-1 d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">groups</span>
                        Lesson Context
                    </h5>
                    <p class="al-text-xs text-muted mb-4">
                        Where this lesson is used.
                    </p>

                    <!-- Applicable Schools -->
                    <div class="mb-3">
                        <label class="al-form-label">Applicable School(s)</label>
                        {% if lesson.applicable_schools.all %}
                        <ul class="list-unstyled mb-0">
                            {% for school in lesson.applicable_schools.all %}
                            <li class="vl-info-badge mb-2">
                                <span class="material-symbols-outlined" style="font-size: 16px;">business</span>
                                {{ school.school_name }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <input type="text" class="al-form-control" value="All Schools" readonly>
                        {% endif %}
                    </div>

                    <!-- Applicable Grades -->
                    <div>
                        <label class="al-form-label">Applicable Grade(s)</label>
                        <input type="text" class="al-form-control" value="{% if lesson.applicable_grades %}Standard {{ lesson.applicable_grades }}{% else %}Not specified{% endif %}" readonly>
                    </div>
                </div>

                <!-- Visibility Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">visibility</span>
                        Visibility
                    </h5>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <p class="al-text-sm fw-medium mb-1">Status</p>
                            <p class="al-text-xs text-muted mb-0">Draft or Published</p>
                        </div>
                        <div class="al-switch disabled {% if lesson.is_published %}active{% endif %}"></div>
                    </div>

                    <hr style="border-color: #F3F4F6;">

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="al-text-sm fw-medium mb-1">Recommend for Low Competency</p>
                            <p class="al-text-xs text-muted mb-0">Suggest to struggling students</p>
                        </div>
                        <div class="al-switch disabled {% if lesson.recommend_low_competency %}active{% endif %}"></div>
                    </div>
                </div>

                <!-- Meta Information Card -->
                <div class="al-card-box">
                    <h5 class="fw-bold mb-3 d-flex align-items-center gap-2">
                        <span class="material-symbols-outlined">info</span>
                        Information
                    </h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Lesson ID</span>
                        <span class="fw-medium">LES-{{ lesson.id|stringformat:"05d" }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Created</span>
                        <span class="fw-medium">{{ lesson.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Last Updated</span>
                        <span class="fw-medium">{{ lesson.updated_at|date:"M d, Y" }}</span>
                    </div>
                    {% if lesson.created_by %}
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Created By</span>
                        <span class="fw-medium">{{ lesson.created_by.get_full_name|default:lesson.created_by.username }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Minimal JS for view mode - just handle switch display
    document.querySelectorAll('.al-switch.active').forEach(function(el) {
        el.style.background = 'linear-gradient(135deg, #6366F1, #8B5CF6)';
    });

    // Tab switching functionality for Learning Content
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.al-lesson-tabs button');
        const allPanels = document.querySelectorAll('.vl-content-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');

                // Hide all content panels
                allPanels.forEach(panel => panel.classList.remove('active'));

                // Show the selected content panel
                const contentType = this.getAttribute('data-content-type');
                const panelId = contentType === 'mixed' ? 'vlMixedContent' : 
                               contentType === 'video' ? 'vlVideoContent' :
                               contentType === 'article' ? 'vlArticleContent' :
                               contentType === 'quiz' ? 'vlQuizContent' : null;
                
                if (panelId) {
                    const panel = document.getElementById(panelId);
                    if (panel) panel.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}
